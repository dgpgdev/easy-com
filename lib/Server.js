'use strict';var _extends2=require('babel-runtime/helpers/extends'),_extends3=_interopRequireDefault(_extends2),_classCallCheck2=require('babel-runtime/helpers/classCallCheck'),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require('babel-runtime/helpers/createClass'),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require('babel-runtime/helpers/possibleConstructorReturn'),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require('babel-runtime/helpers/inherits'),_inherits3=_interopRequireDefault(_inherits2),_events=require('events'),_events2=_interopRequireDefault(_events),_ws=require('ws'),_ws2=_interopRequireDefault(_ws),_uuid=require('uuid'),_uuid2=_interopRequireDefault(_uuid),_RoomManager=require('./rooms/RoomManager'),_RoomManager2=_interopRequireDefault(_RoomManager),_MiddleWareManager=require('./middleware/MiddleWareManager'),_MiddleWareManager2=_interopRequireDefault(_MiddleWareManager);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var Server=function(a){function b(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{host:'localhost',port:5678};(0,_classCallCheck3.default)(this,b);var c=(0,_possibleConstructorReturn3.default)(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c._config=a,_events2.default.EventEmitter.call(c),c._roomManager=new _RoomManager2.default,c.middlewareManager=new _MiddleWareManager2.default,c}return(0,_inherits3.default)(b,a),(0,_createClass3.default)(b,[{key:'use',value:function use(a){return this.middlewareManager.use(a),this}},{key:'initListeners',value:function initListeners(){var a=this;this.ws.on('connection',function(b){b.uuid=_uuid2.default.v1(),b.rooms=[],b.join=function(c){a._roomManager.join(c,b)},b.leave=function(c){a._roomManager.leave(c,b)},b.leaveAll=function(){b.rooms.forEach(function(a){b.leave(a)})},b.room=function(b){return a._roomManager.getRoom(b)},b.invoke=function(){for(var a=arguments.length,c=Array(a),d=0;d<a;d++)c[d]=arguments[d];b.send(JSON.stringify(c))},b.to=function(b){return a.ws.clients.filter(function(a){return a.uuid===b})[0]},b.broadcast=function(b){for(var c=arguments.length,d=Array(1<c?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];a.ws.clients.forEach(function(c){return c.invoke.apply(a,[b].concat(d))})},b.on('message',function(c){var e=JSON.parse(c);e.splice(1,0,b),a.middlewareManager.executeMiddleware(e[0],e[1],e.slice(2),function(){return a.emit.apply(a,e)})}),b.on('close',function(c,d){a.emit('disconnect',b,c,d)}),a.createListeners(b,['error','ping','pong','open']),a.emit('connect',b)}),this.createListeners(this.ws,['error','headers'])}},{key:'createListeners',value:function createListeners(a,b){var c=this;b.forEach(function(b){a.on(b,function(a){c.emit(b,a)})})}},{key:'start',value:function start(){this.ws=new _ws2.default.Server(this.config),this.initListeners(),this.sendStatus((0,_extends3.default)({statudID:0,message:'Server is ready'},this.config))}},{key:'stop',value:function stop(){var a=this;this.ws.close(function(b){return a.sendStatus({statudID:1,message:'Server stopped',error:b})})}},{key:'sendStatus',value:function sendStatus(a){this.emit('status',a)}},{key:'clients',get:function get(){return this.ws.clients}},{key:'rooms',get:function get(){return this._roomManager.rooms}},{key:'roomManager',get:function get(){return this._roomManager}},{key:'config',get:function get(){return this._config},set:function set(a){a&&(this._config=a)}}]),b}(_events2.default.EventEmitter);exports.default=Server;